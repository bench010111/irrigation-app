<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ìˆ˜ì œì–´ ì‹œìŠ¤í…œ ğŸ’¦</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
  <div class="container">
    <div class="left-panel">
      <h2>ë¶êµ¬ì²­ ë„ì‹œìˆ² ê´€ìˆ˜ì œì–´ âš™ï¸</h2>
      {% for i in range(1, 6) %}
      <div class="valve-block" id="valve-{{ i }}" data-valve="{{ i }}">
        <h3>ê´€ìˆ˜#{{ i }}</h3>
        <div class="valves-row">
          {% for j in range(1, 3) %}
          <div class="valve-box">
            <h4>ë°¸ë¸Œ {{ j }}</h4>
            <div class="manual-control-row">
              <span class="manual-control-label">ìˆ˜ë™ ì œì–´:</span>
              <button class="valve-toggle" onclick="toggleValve('{{ i }}', '{{ j }}', 'on')" data-valve="{{ i }}-{{ j }}" data-state="on">ON</button>
              <button class="valve-toggle" onclick="toggleValve('{{ i }}', '{{ j }}', 'off')" data-valve="{{ i }}-{{ j }}" data-state="off">OFF</button>
              <span id="status-{{ i }}-{{ j }}"></span>
            </div>
            <div class="schedule">
              <div class="schedule-row">
                <div class="time-group">
                  <label for="start-time-{{ i }}-{{ j }}">ì‹œì‘ì‹œê°„</label>
                  <input type="time" id="start-time-{{ i }}-{{ j }}" name="start-time-{{ i }}-{{ j }}">
                </div>
                <div class="time-group">
                  <label for="runtime-{{ i }}-{{ j }}">ì‘ë™ì‹œê°„</label>
                  <select id="runtime-{{ i }}-{{ j }}" name="runtime-{{ i }}-{{ j }}">
                    <option value="15">15ë¶„</option>
                    <option value="30">30ë¶„</option>
                    <option value="45">45ë¶„</option>
                    <option value="60">60ë¶„</option>
                  </select>
                </div>                
              </div>
              <div class="repeat-clear-row">
                <div class="repeat-group">
                  <label for="repeat-daily-{{ i }}-{{ j }}">ë§¤ì¼ ë°˜ë³µ</label>
                  <input type="checkbox" id="repeat-daily-{{ i }}-{{ j }}" name="repeat-daily-{{ i }}-{{ j }}">
                </div>
                <button class="clear-reservation" onclick="clearReservation('{{ i }}', '{{ j }}')">ì˜ˆì•½ ì´ˆê¸°í™”</button>
              </div>
            </div>                                                 
            <div class="runtime">
              <p>ëˆ„ì  ì‘ë™ ì‹œê°„: <span id="runtime-{{ i }}-{{ j }}">0</span> ì´ˆ</p>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}      
    </div>
    
    <div class="right-panel">
      <div class="map-cctv-wrapper">
        <div class="map-container">
          <h2>ğŸ—ºï¸ ë„ì‹œìˆ² ì§€ë„</h2>
          <div class="map-img-wrapper" style="position: relative;">
            <!-- Base map layer -->
            <img src="{{ url_for('static', filename='map_layer_1.png') }}" alt="ì§€ë„" class="map-img base-layer" style="position:absolute; top:0; left:0; z-index:1;">
            
            <!-- Dynamic Highlight Layers for irrigation groups -->
            <img id="map-overlay-2-1" src="{{ url_for('static', filename='map_layer_2_1.png') }}" alt="í•˜ì´ë¼ì´íŠ¸ 1" class="map-img overlay-layer" style="position:absolute; top:0; left:0; z-index:2; display:none; pointer-events:none;">
            <img id="map-overlay-2-2" src="{{ url_for('static', filename='map_layer_2_2.png') }}" alt="í•˜ì´ë¼ì´íŠ¸ 2" class="map-img overlay-layer" style="position:absolute; top:0; left:0; z-index:2; display:none; pointer-events:none;">
            <img id="map-overlay-2-3" src="{{ url_for('static', filename='map_layer_2_3.png') }}" alt="í•˜ì´ë¼ì´íŠ¸ 3" class="map-img overlay-layer" style="position:absolute; top:0; left:0; z-index:2; display:none; pointer-events:none;">
            <img id="map-overlay-2-4" src="{{ url_for('static', filename='map_layer_2_4.png') }}" alt="í•˜ì´ë¼ì´íŠ¸ 4" class="map-img overlay-layer" style="position:absolute; top:0; left:0; z-index:2; display:none; pointer-events:none;">
            <img id="map-overlay-2-5" src="{{ url_for('static', filename='map_layer_2_5.png') }}" alt="í•˜ì´ë¼ì´íŠ¸ 5" class="map-img overlay-layer" style="position:absolute; top:0; left:0; z-index:2; display:none; pointer-events:none;">
            
            <!-- Overlay map layer (always visible) -->
            <img src="{{ url_for('static', filename='map_layer_99.png') }}" class="map-img overlay-layer overlay-layer-99" style="position:absolute; top:0; left:0; z-index:3;">

          </div>                     
        </div>
        <div class="cctv-container">
          <h2>ğŸ“¹ CCTV ëª¨ë‹ˆí„°ë§</h2>
          <div class="cctv-placeholder">CCTV í™”ë©´ ìë¦¬</div>
        </div>
      </div>
      
      <div class="log-section">
        <h2>ğŸ§¾ ì‹œìŠ¤í…œ ë¡œê·¸</h2>
        <p>ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
      </div>
    </div>
  </div>  

  <script>
    // âœ… ë°¸ë¸Œ ìˆ˜ë™ ì œì–´ (ì¼œê¸°/ë„ê¸° ë²„íŠ¼)
    $(".valve-toggle").on("click", function () {
      const valve = $(this).data("valve");  // ê´€ìˆ˜ë²ˆí˜¸-ë°¸ë¸Œë²ˆí˜¸ ì˜ˆ: "1-1"
      const state = $(this).data("state");  // on/off
      const [irrigation, valveNum] = valve.split('-');

      $.ajax({
        type: "POST",
        url: "/toggle-valve",
        data: {
          irrigation: irrigation,
          valve: valveNum,
          state: state
        },
        success: function (response) {
          // ìƒíƒœ ì—…ë°ì´íŠ¸
          if (state === "on") {
            $(`[data-valve="${irrigation}-${valveNum}"][data-state="on"]`).prop('disabled', true);
            $(`[data-valve="${irrigation}-${valveNum}"][data-state="off"]`).prop('disabled', false);
            $(`#status-${irrigation}-${valveNum}`).text("[ì¼œì§]");
          } else {
            $(`[data-valve="${irrigation}-${valveNum}"][data-state="off"]`).prop('disabled', true);
            $(`[data-valve="${irrigation}-${valveNum}"][data-state="on"]`).prop('disabled', false);
            $(`#status-${irrigation}-${valveNum}`).text("[êº¼ì§]");
          }

          // ëˆ„ì  ì‹œê°„ í‘œì‹œ
          if (response.runtime_seconds !== undefined) {
            const totalSec = response.runtime_seconds;
            const min = Math.floor(totalSec / 60);
            const sec = totalSec % 60;
            $(`#runtime-${irrigation}-${valveNum}`).text(`${min}ë¶„ ${sec}ì´ˆ`);
          }
        },
        error: function () {
          alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });
    });

    // âœ… ì˜ˆì•½ ì‹œê°„ ì„¤ì •
    $("input[type='time']").on("change", function () {
      const timeType = $(this).attr("name").split("_")[0];
      const [irrigation, valveNum] = $(this).attr("name").split("_").slice(1);
      const value = $(this).val();

      $.ajax({
        type: "POST",
        url: "/set-schedule",
        data: {
          irrigation: irrigation,
          valve: valveNum,
          timeType: timeType,
          value: value
        },
        success: function (response) {
          console.log(`ì˜ˆì•½ ${timeType} ì‹œê°„ ì„¤ì •ë¨: ${value}`);
        },
        error: function () {
          alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      });
    });
    // âœ… ê´€ìˆ˜ ë²ˆí˜¸ì— ë”°ë¥¸ í•˜ì´ë¼ì´íŠ¸ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
    $(".valve-block").hover(function() {
      const valveId = $(this).data("valve");  // ê´€ìˆ˜ë²ˆí˜¸ (ì˜ˆ: 1, 2, 3, ...)

      // map_layer_99ëŠ” í•­ìƒ ë³´ì´ê²Œ í•˜ê³ , í•´ë‹¹ ê´€ìˆ˜ë²ˆí˜¸ì— ë§ëŠ” map_layer_2_#ë§Œ ë³´ì´ê²Œ í•˜ê¸°
      $(".overlay-layer").not(".overlay-layer-99").hide();  // map_layer_99ëŠ” ìˆ¨ê¸°ì§€ ì•ŠìŒ
      $(`#map-overlay-2-${valveId}`).show();  // í•´ë‹¹ ê´€ìˆ˜ë²ˆí˜¸ì˜ í•˜ì´ë¼ì´íŠ¸ë§Œ ë³´ì´ê²Œ í•˜ê¸°
    }, function() {
      // ë§ˆìš°ìŠ¤ê°€ ë²—ì–´ë‚  ë•Œ ëª¨ë“  í•˜ì´ë¼ì´íŠ¸ ì´ë¯¸ì§€ë¥¼ ìˆ¨ê¸°ê¸°
      $(".overlay-layer").not(".overlay-layer-99").hide();  // map_layer_99ëŠ” ìˆ¨ê¸°ì§€ ì•ŠìŒ
    });
  </script>
  
</body>
</html>
